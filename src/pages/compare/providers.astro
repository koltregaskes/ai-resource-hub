---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getProvidersWithCounts, getModelsByCategory } from '../../db/queries';

const rawBase = import.meta.env.BASE_URL;
const base = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;

const providers = getProvidersWithCounts();
const allLLMs = getModelsByCategory('llm');

// Compute provider stats
const providerStats = providers
  .filter(p => p.modelCount > 0)
  .map(p => {
    const models = allLLMs.filter(m => m.provider === p.name);
    const bestQuality = models.length > 0 ? Math.max(...models.map(m => m.qualityScore)) : 0;
    const cheapestInput = models.filter(m => m.inputPrice > 0).length > 0
      ? Math.min(...models.filter(m => m.inputPrice > 0).map(m => m.inputPrice))
      : 0;
    const avgQuality = models.length > 0
      ? models.reduce((sum, m) => sum + m.qualityScore, 0) / models.length
      : 0;
    const hasOpenSource = models.some(m => m.openSource);
    const maxContext = models.length > 0 ? Math.max(...models.map(m => m.contextWindow)) : 0;
    const fastestSpeed = models.length > 0 ? Math.max(...models.map(m => m.speed)) : 0;
    return {
      ...p,
      llmCount: models.length,
      bestQuality,
      cheapestInput,
      avgQuality,
      hasOpenSource,
      maxContext,
      fastestSpeed,
      models,
    };
  })
  .sort((a, b) => b.bestQuality - a.bestQuality);

function formatTokens(n: number): string {
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(n % 1_000_000 === 0 ? 0 : 1)}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(n % 1_000 === 0 ? 0 : 1)}K`;
  return n.toString();
}
---

<BaseLayout
  title="Compare AI Providers — The AI Resource Hub"
  description="Side-by-side comparison of all major AI providers. Compare OpenAI, Anthropic, Google, Meta, and more by model quality, pricing, and capabilities."
>
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <nav class="text-xs text-(--color-text-muted) mb-4" aria-label="Breadcrumb">
      <a href={base} class="hover:text-(--color-text-secondary) transition-colors">Home</a>
      <span class="mx-2">/</span>
      <a href={`${base}labs/`} class="hover:text-(--color-text-secondary) transition-colors">Labs & Providers</a>
      <span class="mx-2">/</span>
      <span class="text-(--color-text-secondary)">Compare Providers</span>
    </nav>

    <div class="mb-8">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-(--color-text-primary) mb-3">
        Compare AI Providers
      </h1>
      <p class="text-(--color-text-secondary) max-w-2xl">
        {providerStats.length} AI providers compared by their best model quality, pricing, context windows, speed, and model lineup.
      </p>
    </div>

    <!-- Provider comparison table -->
    <div class="mb-10">
      <div class="rounded-xl border border-(--color-border) bg-(--color-bg-card) overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-(--color-border)">
              <th class="text-center py-3 px-2 text-(--color-text-muted) font-medium w-10">#</th>
              <th class="text-left py-3 px-4 text-(--color-text-muted) font-medium">Provider</th>
              <th class="text-right py-3 px-4 text-(--color-text-muted) font-medium">Best Quality</th>
              <th class="text-right py-3 px-4 text-(--color-text-muted) font-medium hidden sm:table-cell">LLMs</th>
              <th class="text-right py-3 px-4 text-(--color-text-muted) font-medium hidden md:table-cell">Total Models</th>
              <th class="text-right py-3 px-4 text-(--color-text-muted) font-medium hidden lg:table-cell">Cheapest Input</th>
              <th class="text-right py-3 px-4 text-(--color-text-muted) font-medium hidden lg:table-cell">Max Context</th>
              <th class="text-right py-3 px-4 text-(--color-text-muted) font-medium hidden md:table-cell">Speed</th>
              <th class="text-center py-3 px-4 text-(--color-text-muted) font-medium hidden sm:table-cell">OSS</th>
            </tr>
          </thead>
          <tbody>
            {providerStats.map((p, i) => (
              <tr class={`border-b border-(--color-border)/50 hover:bg-(--color-bg-hover) transition-colors ${i < 3 ? 'bg-(--color-accent)/5' : ''}`}>
                <td class="py-3 px-2 text-center">
                  <span class={`text-sm font-bold ${i === 0 ? 'text-amber-400' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-amber-600' : 'text-(--color-text-muted)'}`}>
                    {i + 1}
                  </span>
                </td>
                <td class="py-3 px-4">
                  <a href={`${base}labs/${p.id}/`} class="flex items-center gap-2 text-(--color-text-primary) hover:text-(--color-accent) transition-colors">
                    <span class="w-3 h-3 rounded-full shrink-0" style={`background-color: ${p.colour}`}></span>
                    <span class="font-medium">{p.name}</span>
                  </a>
                  {p.founded && <span class="text-[10px] text-(--color-text-muted)">Founded {p.founded}</span>}
                </td>
                <td class="py-3 px-4 text-right">
                  <span class={`font-mono font-bold ${p.bestQuality >= 90 ? 'text-green-400' : p.bestQuality >= 80 ? 'text-(--color-accent)' : 'text-(--color-text-secondary)'}`}>
                    {p.bestQuality.toFixed(1)}
                  </span>
                </td>
                <td class="py-3 px-4 text-right hidden sm:table-cell">
                  <span class="font-mono text-xs text-(--color-text-secondary)">{p.llmCount}</span>
                </td>
                <td class="py-3 px-4 text-right hidden md:table-cell">
                  <span class="font-mono text-xs text-(--color-text-secondary)">{p.modelCount}</span>
                </td>
                <td class="py-3 px-4 text-right hidden lg:table-cell">
                  <span class="font-mono text-xs text-(--color-text-secondary)">
                    {p.cheapestInput > 0 ? `$${p.cheapestInput.toFixed(2)}` : p.llmCount > 0 ? 'Free' : '—'}
                  </span>
                </td>
                <td class="py-3 px-4 text-right hidden lg:table-cell">
                  <span class="text-xs text-(--color-text-muted)">{p.maxContext > 0 ? formatTokens(p.maxContext) : '—'}</span>
                </td>
                <td class="py-3 px-4 text-right hidden md:table-cell">
                  <span class="text-xs text-(--color-text-muted)">{p.fastestSpeed > 0 ? `${p.fastestSpeed} tok/s` : '—'}</span>
                </td>
                <td class="py-3 px-4 text-center hidden sm:table-cell">
                  {p.hasOpenSource
                    ? <span class="text-[9px] px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-400">Yes</span>
                    : <span class="text-(--color-text-muted)">—</span>
                  }
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Provider cards with model lineups -->
    <div class="mb-10">
      <h2 class="text-xl font-bold text-(--color-text-primary) mb-4">Provider Model Lineups</h2>
      <div class="space-y-4">
        {providerStats.filter(p => p.llmCount > 0).slice(0, 12).map(p => (
          <div class="rounded-xl border border-(--color-border) bg-(--color-bg-card) p-5">
            <div class="flex items-center gap-3 mb-3">
              <span class="w-4 h-4 rounded-full shrink-0" style={`background-color: ${p.colour}`}></span>
              <a href={`${base}labs/${p.id}/`} class="text-lg font-bold text-(--color-text-primary) hover:text-(--color-accent) transition-colors">{p.name}</a>
              <span class="text-xs text-(--color-text-muted) bg-(--color-bg-tertiary) px-2 py-0.5 rounded-full">{p.llmCount} LLMs</span>
              {p.hasOpenSource && <span class="text-[9px] px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-400">Open Source</span>}
            </div>
            {p.description && <p class="text-xs text-(--color-text-muted) mb-3">{p.description}</p>}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
              {p.models.sort((a, b) => b.qualityScore - a.qualityScore).slice(0, 6).map((m, mi) => (
                <a href={`${base}models/${m.id}/`} class="flex items-center justify-between gap-2 px-3 py-2 rounded-lg bg-(--color-bg-tertiary) hover:bg-(--color-bg-hover) transition-colors text-xs group">
                  <div class="flex items-center gap-2 min-w-0">
                    <span class={`font-bold shrink-0 ${mi === 0 ? 'text-amber-400' : 'text-(--color-text-muted)'}`}>
                      {mi + 1}.
                    </span>
                    <span class="text-(--color-text-primary) group-hover:text-(--color-accent) transition-colors truncate">{m.name}</span>
                    {m.openSource && <span class="text-[8px] px-1 py-0.5 rounded bg-purple-500/20 text-purple-400 shrink-0">OSS</span>}
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <span class="font-mono text-(--color-accent)">{m.qualityScore.toFixed(1)}</span>
                    <span class="font-mono text-(--color-text-muted)">{m.inputPrice > 0 ? `$${m.inputPrice.toFixed(2)}` : 'Free'}</span>
                  </div>
                </a>
              ))}
            </div>
            {p.models.length > 6 && (
              <a href={`${base}labs/${p.id}/`} class="block mt-2 text-xs text-(--color-accent) hover:text-(--color-accent-hover) transition-colors">
                View all {p.models.length} models &rarr;
              </a>
            )}
          </div>
        ))}
      </div>
    </div>

    <div class="mt-6 flex flex-wrap justify-center gap-4">
      <a href={`${base}labs/`} class="text-sm text-(--color-accent) hover:text-(--color-accent-hover) transition-colors">
        All providers &rarr;
      </a>
      <a href={`${base}compare/head-to-head/`} class="text-sm text-(--color-accent) hover:text-(--color-accent-hover) transition-colors">
        Compare models head-to-head &rarr;
      </a>
      <a href={`${base}leaderboard/`} class="text-sm text-(--color-accent) hover:text-(--color-accent-hover) transition-colors">
        Model leaderboard &rarr;
      </a>
    </div>
  </section>
</BaseLayout>
