---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getModelsByCategory } from '../../db/queries';

const rawBase = import.meta.env.BASE_URL;
const base = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;

const models = getModelsByCategory('llm');

const modelsJSON = JSON.stringify(models.map(m => ({
  id: m.id,
  name: m.name,
  provider: m.provider,
  providerColour: m.providerColour,
  inputPrice: m.inputPrice,
  outputPrice: m.outputPrice,
  contextWindow: m.contextWindow,
  maxOutput: m.maxOutput,
  speed: m.speed,
  qualityScore: m.qualityScore,
  released: m.released,
  openSource: m.openSource,
  modality: m.modality,
  apiAvailable: m.apiAvailable,
  notes: m.notes,
})));
---

<BaseLayout
  title="Which AI Should I Use? — The AI Resource Hub"
  description="Take our interactive quiz to find the best AI model for your needs. Answer 8 questions and get personalised recommendations based on real model data."
>
  <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <nav class="text-xs text-(--color-text-muted) mb-4" aria-label="Breadcrumb">
      <a href={base} class="hover:text-(--color-text-secondary) transition-colors">Home</a>
      <span class="mx-2">/</span>
      <span class="text-(--color-text-secondary)">Which AI Should I Use?</span>
    </nav>

    <div class="mb-8">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-(--color-text-primary) mb-3">
        Which AI Should I Use?
      </h1>
      <p class="text-(--color-text-secondary) max-w-2xl">
        Answer 8 quick questions and we'll recommend the best AI model for your specific needs.
        No account needed, no data collected — just honest recommendations based on real model data.
      </p>
    </div>

    <!-- Progress bar -->
    <div id="quiz-progress" class="mb-6">
      <div class="flex items-center justify-between text-xs text-(--color-text-muted) mb-2">
        <span id="progress-label">Question 1 of 8</span>
        <span id="progress-pct">0%</span>
      </div>
      <div class="w-full h-2 rounded-full bg-(--color-bg-tertiary) overflow-hidden">
        <div id="progress-bar" class="h-full rounded-full bg-(--color-accent) transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Quiz container -->
    <div id="quiz-container">
      <!-- Questions are rendered by JS -->
    </div>

    <!-- Results container (hidden initially) -->
    <div id="quiz-results" class="hidden">
      <!-- Results are rendered by JS -->
    </div>

    <!-- How it works -->
    <div class="mt-12 p-5 rounded-xl bg-(--color-bg-card) border border-(--color-border)">
      <h2 class="text-lg font-semibold text-(--color-text-primary) mb-2">How this quiz works</h2>
      <p class="text-sm text-(--color-text-secondary) leading-relaxed">
        Each answer adjusts a scoring profile that is matched against real model data — pricing, speed benchmarks,
        context window sizes, modality support, and open-source status. The final ranking shows which models
        best fit your specific requirements. This quiz is completely independent — we're not affiliated with any
        AI company and receive no compensation for recommendations.
      </p>
    </div>
  </section>

  <script define:vars={{ modelsJSON, base }}>
    const models = JSON.parse(modelsJSON);

    /* ─── Questions ───────────────────────────────────────────── */
    const questions = [
      {
        id: 'use_case',
        title: 'What will you primarily use AI for?',
        subtitle: 'Pick the option closest to your main use case.',
        options: [
          { label: 'Coding & development', value: 'coding', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>' },
          { label: 'Writing & content creation', value: 'writing', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>' },
          { label: 'Research & analysis', value: 'research', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>' },
          { label: 'General chatbot / assistant', value: 'chatbot', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>' },
        ],
      },
      {
        id: 'budget',
        title: 'What is your budget?',
        subtitle: 'How much are you willing to spend on AI API usage?',
        options: [
          { label: 'Free only', value: 'free', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' },
          { label: 'Low budget (< $5/mo)', value: 'low', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>' },
          { label: 'Moderate ($5-50/mo)', value: 'medium', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>' },
          { label: 'High ($50+/mo)', value: 'high', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>' },
        ],
      },
      {
        id: 'speed_quality',
        title: 'Speed vs quality — what matters more?',
        subtitle: 'Some models are faster but less accurate; others are slower but more capable.',
        options: [
          { label: 'Speed is everything — I need instant responses', value: 'speed', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' },
          { label: 'Balanced — good enough speed with solid quality', value: 'balanced', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>' },
          { label: 'Quality first — I can wait for the best output', value: 'quality', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>' },
        ],
      },
      {
        id: 'open_source',
        title: 'Do you care about open source?',
        subtitle: 'Open-source models can be self-hosted and customised. Closed models are often more polished.',
        options: [
          { label: 'Must be open source', value: 'required', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
          { label: 'Prefer open source but not required', value: 'prefer', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/></svg>' },
          { label: 'Don\'t care — just give me the best model', value: 'no_preference', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>' },
        ],
      },
      {
        id: 'context_window',
        title: 'How much text do you need to process at once?',
        subtitle: 'Larger context windows let you handle longer documents but may cost more.',
        options: [
          { label: 'Short conversations — a few paragraphs', value: 'small', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>' },
          { label: 'Medium — several pages of text', value: 'medium', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>' },
          { label: 'Large — entire documents or codebases', value: 'large', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>' },
          { label: 'Massive — 100K+ tokens, books, huge repos', value: 'massive', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>' },
        ],
      },
      {
        id: 'multimodal',
        title: 'Do you need multimodal capabilities?',
        subtitle: 'Some models can understand images, generate images, or work with audio.',
        options: [
          { label: 'Text only is fine', value: 'text_only', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/></svg>' },
          { label: 'I need image understanding (vision)', value: 'vision', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' },
          { label: 'I need full multimodal (image + audio + more)', value: 'full_multimodal', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
        ],
      },
      {
        id: 'privacy',
        title: 'How important is data privacy?',
        subtitle: 'Some users prefer models that can be self-hosted or have strict data policies.',
        options: [
          { label: 'Critical — I need full control of my data', value: 'critical', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>' },
          { label: 'Important — prefer privacy-friendly options', value: 'important', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>' },
          { label: 'Not a concern — I just want the best results', value: 'not_concerned', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' },
        ],
      },
      {
        id: 'api_access',
        title: 'How will you access the model?',
        subtitle: 'Do you need programmatic API access, or is a web chat interface enough?',
        options: [
          { label: 'API access is essential', value: 'api_required', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>' },
          { label: 'Web interface is fine', value: 'web_only', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>' },
          { label: 'Both — I want flexibility', value: 'both', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>' },
        ],
      },
    ];

    /* ─── State ───────────────────────────────────────────────── */
    let currentQuestion = 0;
    const answers = {};

    /* ─── DOM refs ────────────────────────────────────────────── */
    const container = document.getElementById('quiz-container');
    const resultsContainer = document.getElementById('quiz-results');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const progressPct = document.getElementById('progress-pct');
    const progressSection = document.getElementById('quiz-progress');

    /* ─── Render helpers ─────────────────────────────────────── */
    function renderQuestion(index) {
      const q = questions[index];
      const pct = Math.round((index / questions.length) * 100);
      progressBar.style.width = pct + '%';
      progressLabel.textContent = `Question ${index + 1} of ${questions.length}`;
      progressPct.textContent = pct + '%';

      container.innerHTML = `
        <div class="rounded-xl border border-(--color-border) bg-(--color-bg-card) p-5 sm:p-8">
          <h2 class="text-xl sm:text-2xl font-bold text-(--color-text-primary) mb-2">${q.title}</h2>
          <p class="text-sm text-(--color-text-secondary) mb-6">${q.subtitle}</p>
          <div class="space-y-3" id="quiz-options">
            ${q.options.map((opt, i) => `
              <button
                class="quiz-option w-full text-left p-4 rounded-lg border border-(--color-border) bg-(--color-bg-secondary) hover:bg-(--color-bg-hover) hover:border-(--color-accent)/50 transition-all duration-200 flex items-center gap-4 group"
                data-value="${opt.value}"
                data-question="${q.id}"
              >
                <span class="shrink-0 w-10 h-10 rounded-lg bg-(--color-bg-tertiary) flex items-center justify-center text-(--color-text-muted) group-hover:text-(--color-accent) transition-colors">
                  ${opt.icon}
                </span>
                <span class="text-sm sm:text-base font-medium text-(--color-text-primary) group-hover:text-(--color-accent) transition-colors">${opt.label}</span>
              </button>
            `).join('')}
          </div>
          ${index > 0 ? `
            <button id="quiz-back" class="mt-6 text-sm text-(--color-text-muted) hover:text-(--color-text-secondary) transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              Previous question
            </button>
          ` : ''}
        </div>
      `;

      // Bind option clicks
      container.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[btn.dataset.question] = btn.dataset.value;

          // Visual feedback — highlight selected
          container.querySelectorAll('.quiz-option').forEach(b => {
            b.classList.remove('border-(--color-accent)', 'bg-(--color-accent)/10');
          });
          btn.classList.add('border-(--color-accent)', 'bg-(--color-accent)/10');

          // Move to next question after a brief delay
          setTimeout(() => {
            if (currentQuestion < questions.length - 1) {
              currentQuestion++;
              renderQuestion(currentQuestion);
            } else {
              showResults();
            }
          }, 250);
        });
      });

      // Bind back button
      const backBtn = document.getElementById('quiz-back');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          currentQuestion--;
          renderQuestion(currentQuestion);
        });
      }
    }

    /* ─── Scoring engine ─────────────────────────────────────── */
    function scoreModels() {
      return models.map(model => {
        let score = 0;
        const nameLC = (model.name || '').toLowerCase();
        const notesLC = (model.notes || '').toLowerCase();
        const modality = (model.modality || '').toLowerCase();

        // 1. Use case scoring (0-30 points)
        const useCase = answers.use_case;
        if (useCase === 'coding') {
          if (nameLC.includes('code') || nameLC.includes('coder') || nameLC.includes('codestral') || notesLC.includes('code') || notesLC.includes('coding')) {
            score += 30;
          } else if (notesLC.includes('programming') || notesLC.includes('developer')) {
            score += 20;
          }
          // High quality models tend to be good at coding
          score += (model.qualityScore / 100) * 15;
        } else if (useCase === 'writing') {
          if (notesLC.includes('writing') || notesLC.includes('creative') || notesLC.includes('content')) {
            score += 25;
          }
          // High quality + large output = good for writing
          score += (model.qualityScore / 100) * 15;
          score += Math.min(10, (model.maxOutput / 8000) * 10);
        } else if (useCase === 'research') {
          if (notesLC.includes('research') || notesLC.includes('analysis') || notesLC.includes('reasoning')) {
            score += 25;
          }
          // Large context + quality = good for research
          score += (model.qualityScore / 100) * 15;
          score += Math.min(10, (model.contextWindow / 200000) * 10);
        } else if (useCase === 'chatbot') {
          // For chatbots: speed + quality balance
          score += (model.speed / 100) * 12;
          score += (model.qualityScore / 100) * 12;
          if (notesLC.includes('chat') || notesLC.includes('assistant') || notesLC.includes('conversational')) {
            score += 10;
          }
        }

        // 2. Budget scoring (0-25 points)
        const budget = answers.budget;
        const avgPrice = (model.inputPrice + model.outputPrice) / 2;
        if (budget === 'free') {
          if (model.inputPrice === 0 && model.outputPrice === 0) {
            score += 25;
          } else if (avgPrice < 0.5) {
            score += 10;
          } else {
            score -= 10;
          }
        } else if (budget === 'low') {
          if (avgPrice === 0) {
            score += 20;
          } else if (avgPrice < 1) {
            score += 25;
          } else if (avgPrice < 3) {
            score += 15;
          } else if (avgPrice < 10) {
            score += 5;
          } else {
            score -= 5;
          }
        } else if (budget === 'medium') {
          // Medium budget — prefer good value
          if (avgPrice <= 5) {
            score += 20;
          } else if (avgPrice <= 15) {
            score += 15;
          } else if (avgPrice <= 30) {
            score += 10;
          } else {
            score += 5;
          }
          // Also reward quality
          score += (model.qualityScore / 100) * 5;
        } else if (budget === 'high') {
          // High budget — prioritise quality over cost
          score += (model.qualityScore / 100) * 25;
        }

        // 3. Speed vs quality (0-20 points)
        const speedPref = answers.speed_quality;
        if (speedPref === 'speed') {
          score += (model.speed / 100) * 20;
        } else if (speedPref === 'balanced') {
          score += (model.speed / 100) * 10;
          score += (model.qualityScore / 100) * 10;
        } else if (speedPref === 'quality') {
          score += (model.qualityScore / 100) * 20;
        }

        // 4. Open source preference (0-15 points)
        const osPref = answers.open_source;
        if (osPref === 'required') {
          if (model.openSource) {
            score += 15;
          } else {
            score -= 20; // Strong penalty
          }
        } else if (osPref === 'prefer') {
          if (model.openSource) {
            score += 10;
          }
        }
        // no_preference: no adjustment

        // 5. Context window (0-15 points)
        const ctxPref = answers.context_window;
        const ctxK = model.contextWindow / 1000;
        if (ctxPref === 'small') {
          // Don't penalise large context, but don't reward excessively
          score += Math.min(8, ctxK / 16 * 8);
        } else if (ctxPref === 'medium') {
          if (ctxK >= 32) score += 10;
          else if (ctxK >= 16) score += 7;
          else score += 3;
        } else if (ctxPref === 'large') {
          if (ctxK >= 128) score += 15;
          else if (ctxK >= 64) score += 10;
          else if (ctxK >= 32) score += 5;
        } else if (ctxPref === 'massive') {
          if (ctxK >= 200) score += 15;
          else if (ctxK >= 128) score += 10;
          else if (ctxK >= 64) score += 5;
          else score -= 5;
        }

        // 6. Multimodal (0-10 points)
        const mmPref = answers.multimodal;
        if (mmPref === 'vision') {
          if (modality.includes('image') || modality.includes('vision')) {
            score += 10;
          }
        } else if (mmPref === 'full_multimodal') {
          const modalities = modality.split(',').length;
          if (modalities >= 3) score += 10;
          else if (modalities >= 2) score += 7;
          else if (modality.includes('image') || modality.includes('vision')) score += 5;
        }
        // text_only: no adjustment

        // 7. Privacy (0-10 points)
        const privPref = answers.privacy;
        if (privPref === 'critical') {
          if (model.openSource) {
            score += 10; // Can self-host
          } else {
            score -= 5;
          }
        } else if (privPref === 'important') {
          if (model.openSource) {
            score += 5;
          }
        }

        // 8. API access (0-5 points)
        const apiPref = answers.api_access;
        if (apiPref === 'api_required' || apiPref === 'both') {
          if (model.apiAvailable) {
            score += 5;
          } else {
            score -= 5;
          }
        }

        return { ...model, score };
      }).sort((a, b) => b.score - a.score);
    }

    /* ─── Format helpers ─────────────────────────────────────── */
    function formatContext(tokens) {
      if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
      if (tokens >= 1000) return Math.round(tokens / 1000) + 'K';
      return tokens.toString();
    }

    function formatPrice(price) {
      if (price === 0) return 'Free';
      if (price < 0.01) return '<$0.01';
      return '$' + price.toFixed(2);
    }

    /* ─── Show results ───────────────────────────────────────── */
    function showResults() {
      const scored = scoreModels();
      const top = scored.slice(0, 5);
      const maxScore = top[0]?.score || 1;

      // Update progress to 100%
      progressBar.style.width = '100%';
      progressLabel.textContent = 'Quiz complete!';
      progressPct.textContent = '100%';

      container.classList.add('hidden');
      resultsContainer.classList.remove('hidden');

      resultsContainer.innerHTML = `
        <div class="mb-8">
          <h2 class="text-2xl sm:text-3xl font-extrabold text-(--color-text-primary) mb-2">Your Top Recommendations</h2>
          <p class="text-(--color-text-secondary)">
            Based on your answers, here are the AI models that best match your needs.
          </p>
        </div>

        <div class="space-y-4 mb-8">
          ${top.map((model, i) => {
            const pct = Math.round((model.score / maxScore) * 100);
            const rank = i + 1;
            const badge = rank === 1 ? '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-(--color-accent)/20 text-(--color-accent)">Best Match</span>' : '';
            return `
              <div class="rounded-xl border border-(--color-border) ${rank === 1 ? 'bg-(--color-accent)/5 border-(--color-accent)/30' : 'bg-(--color-bg-card)'} p-5 transition-all hover:border-(--color-accent)/40">
                <div class="flex items-start justify-between gap-4 mb-3">
                  <div class="flex items-center gap-3 min-w-0">
                    <span class="shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${rank === 1 ? 'bg-(--color-accent) text-white' : 'bg-(--color-bg-tertiary) text-(--color-text-secondary)'}">${rank}</span>
                    <div class="min-w-0">
                      <div class="flex items-center gap-2 flex-wrap">
                        <a href="${base}models/${model.id}/" class="font-bold text-(--color-text-primary) hover:text-(--color-accent) transition-colors truncate">${model.name}</a>
                        ${badge}
                      </div>
                      <div class="flex items-center gap-1.5 mt-0.5">
                        <span class="w-2 h-2 rounded-full shrink-0" style="background-color: ${model.providerColour}"></span>
                        <span class="text-xs text-(--color-text-muted)">${model.provider}</span>
                      </div>
                    </div>
                  </div>
                  <div class="text-right shrink-0">
                    <div class="text-lg font-bold text-(--color-accent)">${pct}%</div>
                    <div class="text-[10px] text-(--color-text-muted) uppercase tracking-wide">match</div>
                  </div>
                </div>

                <!-- Match bar -->
                <div class="w-full h-1.5 rounded-full bg-(--color-bg-tertiary) mb-4 overflow-hidden">
                  <div class="h-full rounded-full bg-(--color-accent) transition-all duration-500" style="width: ${pct}%"></div>
                </div>

                <!-- Key stats -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
                  <div class="p-2 rounded-lg bg-(--color-bg-secondary)">
                    <div class="text-[10px] text-(--color-text-muted) uppercase tracking-wide mb-0.5">Quality</div>
                    <div class="text-sm font-semibold text-(--color-text-primary)">${model.qualityScore}/100</div>
                  </div>
                  <div class="p-2 rounded-lg bg-(--color-bg-secondary)">
                    <div class="text-[10px] text-(--color-text-muted) uppercase tracking-wide mb-0.5">Speed</div>
                    <div class="text-sm font-semibold text-(--color-text-primary)">${model.speed}/100</div>
                  </div>
                  <div class="p-2 rounded-lg bg-(--color-bg-secondary)">
                    <div class="text-[10px] text-(--color-text-muted) uppercase tracking-wide mb-0.5">Context</div>
                    <div class="text-sm font-semibold text-(--color-text-primary)">${formatContext(model.contextWindow)}</div>
                  </div>
                  <div class="p-2 rounded-lg bg-(--color-bg-secondary)">
                    <div class="text-[10px] text-(--color-text-muted) uppercase tracking-wide mb-0.5">Input Price</div>
                    <div class="text-sm font-semibold text-(--color-text-primary)">${formatPrice(model.inputPrice)}/M</div>
                  </div>
                </div>

                <!-- Tags -->
                <div class="flex flex-wrap gap-1.5 mt-3">
                  ${model.openSource ? '<span class="px-2 py-0.5 text-[10px] rounded-full bg-(--color-bg-tertiary) text-(--color-text-muted)">Open Source</span>' : ''}
                  ${model.apiAvailable ? '<span class="px-2 py-0.5 text-[10px] rounded-full bg-(--color-bg-tertiary) text-(--color-text-muted)">API Available</span>' : ''}
                  ${model.modality && model.modality !== 'text' ? '<span class="px-2 py-0.5 text-[10px] rounded-full bg-(--color-bg-tertiary) text-(--color-text-muted)">Multimodal</span>' : ''}
                </div>

                <a href="${base}models/${model.id}/" class="inline-flex items-center gap-1 mt-3 text-sm font-medium text-(--color-accent) hover:underline">
                  View full details
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
              </div>
            `;
          }).join('')}
        </div>

        <!-- Summary of answers -->
        <div class="rounded-xl border border-(--color-border) bg-(--color-bg-card) p-5 mb-6">
          <h3 class="font-semibold text-(--color-text-primary) mb-3">Your preferences</h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-xs">
            ${questions.map(q => {
              const a = answers[q.id];
              const opt = q.options.find(o => o.value === a);
              return `
                <div class="p-2 rounded-lg bg-(--color-bg-secondary)">
                  <div class="text-(--color-text-muted) mb-0.5">${q.title.replace(/\?$/, '').replace(/—.*/, '').trim()}</div>
                  <div class="text-(--color-text-primary) font-medium">${opt ? opt.label : a}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-3">
          <button id="quiz-restart" class="px-5 py-2.5 rounded-lg bg-(--color-accent) text-white font-medium text-sm hover:opacity-90 transition-opacity">
            Start Over
          </button>
          <a href="${base}compare/llm/" class="px-5 py-2.5 rounded-lg border border-(--color-border) text-(--color-text-secondary) font-medium text-sm hover:bg-(--color-bg-hover) transition-colors">
            Compare All LLMs
          </a>
          <a href="${base}leaderboard/" class="px-5 py-2.5 rounded-lg border border-(--color-border) text-(--color-text-secondary) font-medium text-sm hover:bg-(--color-bg-hover) transition-colors">
            View Leaderboard
          </a>
        </div>
      `;

      // Bind restart
      document.getElementById('quiz-restart')?.addEventListener('click', () => {
        currentQuestion = 0;
        Object.keys(answers).forEach(k => delete answers[k]);
        container.classList.remove('hidden');
        resultsContainer.classList.add('hidden');
        renderQuestion(0);
      });
    }

    /* ─── Start ───────────────────────────────────────────────── */
    renderQuestion(0);
  </script>
</BaseLayout>
